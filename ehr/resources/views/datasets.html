<html>
<script type="text/javascript">

LABKEY.requiresScript("/ehr/ehrAPI.js");


Ext.onReady(function () {
    var config = {displayField: 'Label', headerField: 'Category', target: 'ehrDatasets'};

    var multi = new LABKEY.MultiRequest();

    EHR.utils.getDatasetPermissions({
        success: function(){
            LABKEY.Query.selectRows({
                schemaName: 'study',
                queryName: 'DataSets',
                success: function(results){
                    onSuccess(results)
                },
                scope: this,
                failure: EHR.utils.onError,
                sort: config.headerField+','+config.displayField,
                filterArray: config.filterArray
            });
        },
        scope: this
    });

    function onSuccess(data){
        var menuCfg = {
            renderTo: config.target,
            sections: new Array(),
            //columns: 3,
            //colWidth: 550,
            renderer: function(item){
                var cfg = {
                    html: '<div style="float:left;width:180px;">'+item.name+':</div> [<a href="<%=contextPath%>/ehr<%=containerPath%>/searchPanel.view?schemaName=study&queryName='+item.data.Label+'">Search</a>] [<a href="<%=contextPath%>/query<%=containerPath%>/executeQuery.view?schemaName=study&query.queryName='+item.data.Label+'">View All Records</a>]',
                    style: 'padding-left:5px;padding-bottom:8px'
                };

                if(EHR.permissionMap.hasPermission('Completed', 'admin', {schemaName: 'study', queryName: item.data.Label})){
                    cfg.html += ' [<a href="<%=contextPath%>/ehr<%=containerPath%>/updateQuery.view?schemaName=study&query.queryName='+item.data.Label+'&keyField=lsid">Update Records</a>]';
                }
                return cfg;
            }
        }

        var sections = {};
        var section;
        for (var i=0;i<data.rows.length;i++){
            var row = data.rows[i];
            if(!row.ShowByDefault){
                continue;
            }

            if (!sections[row[config.headerField]]){
                section = {header: row[config.headerField], items: []};
                sections[row[config.headerField]] = section;

                menuCfg.sections.push(section);
            }
            else
                section = sections[row[config.headerField]];

            section.items.push({name: row[config.displayField], data: row})

        }

        new EHR.utils.navMenu(menuCfg);
    }

});

</script>
<body>

<div id="ehrDatasets"></div>

</body>
</html>