<script type="text/javascript">
    LABKEY.requiresScript("/ehr/ehrAPI.js");
</script>
<script type="text/javascript">

Ext.onReady(function () {
    var webpart = <%=webpartContext%>;
    var config = {displayField: 'Label', headerField: 'categoryId/label', target: webpart.wrapperDivId};

    var multi = new LABKEY.MultiRequest();

    EHR.Security.init({
        success: function(){
            LABKEY.Query.selectRows({
                schemaName: 'study',
                queryName: 'DataSets',
                columns: 'categoryId/label,label,ShowByDefault',
                success: function(results){
                    onSuccess(results)
                },
                scope: this,
                failure: EHR.Utils.onError,
                sort: config.headerField+','+config.displayField,
                filterArray: config.filterArray
            });
        },
        scope: this
    });

    function onSuccess(data){
        var menuCfg = {
            renderTo: config.target,
            sections: new Array(),
            renderer: function(item){
                var cfg = {
                    html: '<div style="float:left;width:180px;">'+item.name+':</div> [<a href="<%=contextPath%>/ehr<%=containerPath%>/searchPanel.view?schemaName=study&queryName='+item.data.Label+'">Search</a>] [<a href="<%=contextPath%>/query<%=containerPath%>/executeQuery.view?schemaName=study&query.queryName='+item.data.Label+'">View All Records</a>]',
                    style: 'padding-left:5px;padding-bottom:8px'
                };

                if(EHR.Security.hasPermission('Completed', 'admin', {schemaName: 'study', queryName: item.data.Label})){
                    cfg.html += ' [<a href="<%=contextPath%>/ehr<%=containerPath%>/updateQuery.view?schemaName=study&query.queryName='+item.data.Label+'&keyField=lsid">Update Records</a>]';
                }
                return cfg;
            }
        }

        var sections = {};
        var section;
        for (var i=0;i<data.rows.length;i++){
            var row = data.rows[i];
            if(!row.ShowByDefault){
                continue;
            }

            var sectionName = row[config.headerField] || '';
            if (!sections[sectionName]){
                section = {header: sectionName, items: []};
                sections[sectionName] = section;

                menuCfg.sections.push(section);
            }
            else
                section = sections[sectionName];

            section.items.push({name: row[config.displayField], data: row})

        }

        new EHR.ext.NavMenu(menuCfg);
    }

});

</script>
