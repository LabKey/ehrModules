<html>
<head>

<script type="text/javascript">

LABKEY.requiresScript("/ehr/transposeRows.js");

Ext.onReady(function ()
{
    if (!LABKEY.ActionURL.getParameter('key')){alert('Must Provide Protocol Number'); return false;}

    var protocol = LABKEY.ActionURL.getParameter('key').toLowerCase();

    new EHR.ext.DetailsView({
        schemaName: 'ehr',
        queryName: 'protocol',
        title: 'Protocol Details:',
        renderTo: 'protocolDetails',
        filterArray: [LABKEY.Filter.create('protocol', protocol, LABKEY.Filter.Types.EQUAL)]
    });

    
    new LABKEY.QueryWebPart({
        title: 'Projects Under This Protocol',
        schemaName: 'ehr',
        queryName: 'project',
        allowChooseQuery: false,
        allowChooseView: true,
        showInsertNewButton: false,
        showDeleteButton: false,
        showDetailsColumn: true,
        showUpdateColumn: false,
        buttonBarPosition: 'top',
        filters: [LABKEY.Filter.create('protocol', protocol, LABKEY.Filter.Types.EQUAL)],
        //sort: '-Date',
        scope: this,
        failure: EHR.utils.onError
     }).render('protocolProjects');

    new LABKEY.QueryWebPart({
        title: 'Active Animal Assignments',
        schemaName: 'study',
        queryName: 'Assignment',
        allowChooseQuery: false,
        allowChooseView: true,
        showInsertNewButton: false,
        showRecordSelectors: true,
        showDeleteButton: false,
        showDetailsColumn: true,
        showUpdateColumn: false,
        buttonBarPosition: 'top',
        filters: [LABKEY.Filter.create('project/protocol', protocol, LABKEY.Filter.Types.EQUAL)],
        viewName: 'Active Assignments',
        sort: '-Date',
        scope: this,
        failure: EHR.utils.onError
     }).render('protocolAssignments');


    new LABKEY.QueryWebPart({
        title: 'Historic Assignments By Species Since Approve Date',
        schemaName: 'ehr',
        queryName: 'protocolTotalAnimalsBySpecies',
        viewName: 'With Animals',
        allowChooseQuery: false,
        allowChooseView: true,
        showInsertNewButton: false,
        showDeleteButton: false,
        showDetailsColumn: true,
        showUpdateColumn: false,
        buttonBarPosition: 'top',
        filters: [LABKEY.Filter.create('protocol', protocol, LABKEY.Filter.Types.EQUAL)],
        //viewName: '',
        //sort: '-Date',
        scope: this,
        failure: EHR.utils.onError
     }).render('protocolTotalAnimalsBySpecies');


    new LABKEY.QueryWebPart({
        title: 'Total Historic Assignments By Species',
        schemaName: 'ehr',
        queryName: 'protocolTotalHistoricAnimalsBySpecies',
        allowChooseQuery: false,
        allowChooseView: true,
        showInsertNewButton: false,
        showDeleteButton: false,
        showDetailsColumn: true,
        showUpdateColumn: false,
        buttonBarPosition: 'top',
        filters: [LABKEY.Filter.create('protocol', protocol, LABKEY.Filter.Types.EQUAL)],
        //viewName: '',
        //sort: '-Date',
        scope: this,
        failure: EHR.utils.onError
     }).render('protocolTotalHistoricAnimalsBySpecies');

    new Ext.Panel({
        title: 'Protocol Information',
        bodyStyle: 'padding:5px;',
        items: [{
            xtype: 'button'
            ,html: 'View Charges Under This Protocol'
            ,handler: function(c){
                var params = {schemaName: 'study'};
                params['query.queryName'] = 'charges';
                params['query.project/protocol~eq'] = protocol;

                window.open(LABKEY.ActionURL.buildURL(
                    'query',
                    'executeQuery.view',
                    LABKEY.ActionURL.getContainer(),
                    params
                ));
            }
            ,style: 'padding-bottom:10px'
            ,buttonAlign: 'center'
        },{
            xtype: 'button'
            ,html: 'View Procedures Under This Protocol'
            ,handler: function(c){
                var params = {schemaName: 'study'};
                params['query.queryName'] = 'encounters';
                params['query.project/protocol~eq'] = protocol;

                window.open(LABKEY.ActionURL.buildURL(
                    'query',
                    'executeQuery.view',
                    LABKEY.ActionURL.getContainer(),
                    params
                ));
            }
            ,style: 'padding-bottom:10px'
            ,buttonAlign: 'center'
        },{
            xtype: 'button'
            ,html: 'View All Items Under This Protocol'
            ,handler: function(c){
                var params = {schemaName: 'study'};
                params['query.queryName'] = 'studyData';
                params['query.project/protocol~eq'] = protocol;

                window.open(LABKEY.ActionURL.buildURL(
                    'query',
                    'executeQuery.view',
                    LABKEY.ActionURL.getContainer(),
                    params
                ));
            }
            ,style: 'padding-bottom:10px'
            ,buttonAlign: 'center'
        }]
    }).render('protocolLinks');


//    EHR.utils.isMemberOf(['vets (LDAP)', 'cpi (LDAP)', 'protocol (LDAP)', 'Site Administrators'], loadPdf);
//
    var pdfContainer = '/WNPRC/WNPRC_Units/Animal_Services/Compliance_Training/Private/Protocol_PDFs';

    new LABKEY.QueryWebPart({
        title: 'Procedures Allowed Under This Protocol',
        //containerPath: pdfContainer,
        schemaName: 'ehr',
        queryName: 'ProtocolProcedures',
        allowChooseQuery: false,
        allowChooseView: true,
        showInsertNewButton: false,
        showDeleteButton: false,
        showDetailsColumn: true,
        showUpdateColumn: false,
        buttonBarPosition: 'top',
        filters: [LABKEY.Filter.create('protocol', protocol, LABKEY.Filter.Types.EQUAL)],
        //viewName: '',
        //sort: '-Date',
        scope: this,
        failure: EHR.utils.onError
     }).render('protocolProcedures');


    LABKEY.Security.getSecurableResources({
        containerPath: pdfContainer,
        includeEffectivePermissions: false,
        scope: this,
        success: function(map){
            new LABKEY.QueryWebPart({
                title: 'Protocol PDF',
                containerPath: pdfContainer,
                schemaName: 'lists',
                queryName: 'ProtocolPDFs',
                allowChooseQuery: false,
                allowChooseView: false,
                showInsertNewButton: false,
                showDeleteButton: false,
                showDetailsColumn: false,
                showUpdateColumn: false,
                buttonBarPosition: 'none',
                filters: [LABKEY.Filter.create('protocol', protocol, LABKEY.Filter.Types.EQUAL)],
                scope: this,
                failure: EHR.utils.onError
             }).render('protocolPdf');
        },
        failure: function(e){
            console.log('Error with getSecurableResources');
            console.log(e);
        }
    })




});

</script>
</head>
<body>
    <p/>

	<div id='protocolDetails'></div>

    <p/>

	<div id='protocolPdf'></div>

    <p/>

    <div id='protocolLinks'></div>

    <p/>

    <div id='protocolProjects'>Loading...</div>


    <p/>

    <div id='protocolAssignments'>Loading...</div>

    <p/>

    <div id="protocolTotalAnimalsBySpecies">Loading...</div>

    <p/>

    <div id="protocolTotalHistoricAnimalsBySpecies">Loading...</div>

    <p/>

    <div id="protocolProcedures">Loading...</div>


</body>
</html>