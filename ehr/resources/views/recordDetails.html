<html>
<head>
<script type="text/javascript">

/*!
 * Ext JS Library 3.2.1
 * Copyright(c) 2006-2010 Ext JS, Inc.
 * licensing@extjs.com
 * http://www.extjs.com/license
 */

LABKEY.requiresScript("/ehr/ehrAPI.js");


Ext.onReady(function(){
    if(!LABKEY.ActionURL.getParameter('schemaName') ||
        !LABKEY.ActionURL.getParameter('queryName') ||
        !LABKEY.ActionURL.getParameter('keyField') ||
        !LABKEY.ActionURL.getParameter('key')
    ){
        alert('Missing one or more required params');
        return;
    }

    var panel = new Ext.Panel({
        autoHeight: true,
        //title: 'Record Details',
        border: false,
        style: 'padding-bottom:20px;',
        items: [{
            tag: 'span',
            html: 'Loading...',
            border: false,
            ref: 'detailsDiv',
            style: 'margin-bottom:20px;'
        }]

    });

    if(LABKEY.ActionURL.getParameter('schemaName').match(/^study$/i) && LABKEY.ActionURL.getParameter('keyField').match(/^lsid$/i)){
        panel.add({
            xtype: 'button',
            handler: function(b){
                window.location = LABKEY.ActionURL.buildURL("query", "executeQuery", null, {
                    schemaName: 'auditLog',
                    'query.queryName': 'DatasetAuditEvent',
                    'query.key1~eq': LABKEY.ActionURL.getParameter('key')
                });
            },
            text: 'Audit History'
        });
    }
    panel.render('recordDetailsDiv');

    var params = {
        schemaName: LABKEY.ActionURL.getParameter('schemaName'),
        'query.queryName': LABKEY.ActionURL.getParameter('queryName'),
        _print: 1
    };
    params[LABKEY.ActionURL.getParameter('keyField')] = LABKEY.ActionURL.getParameter('key');

    var request = Ext.Ajax.request({
        url : LABKEY.ActionURL.buildURL("query", "detailsQueryRow", null, params),
        method : 'GET',
        success: function(results){
            panel.detailsDiv.update(results.responseText+'<br>');
        },
        failure: EHR.utils.onError,
        scope: this
    });


LABKEY.NavTrail.setTrail(LABKEY.ActionURL.getParameter('title') || EHR.utils.toTitleCase(LABKEY.ActionURL.getParameter('queryName')));

});


</script>
</head>
<body>
<div id="recordDetailsDiv"></div>



</body>


</html>