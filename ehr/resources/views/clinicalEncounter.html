<html>
<head>
<script type="text/javascript">

/*!
 * Ext JS Library 3.2.1
 * Copyright(c) 2006-2010 Ext JS, Inc.
 * licensing@extjs.com
 * http://www.extjs.com/license
 */

LABKEY.requiresScript("/ehr/ehrFormPanel.js");


Ext.onReady(function(){

    var encounterType = LABKEY.ActionURL.getParameter('encounterType');

    if(!encounterType){
        makeFormSelectorPanel().render('encounterForm');
    }
    else {
        renderForm(encounterType);
    }

    function renderForm(encounterType){
        var panel = makeEncounterPanel(encounterType);

        if(panel){
            LABKEY.NavTrail.setTrail('Clinical Encounter: '+encounterType);
            panel.render('encounterForm');
        }
        else {
            alert('Form type: '+encounterType+' not found');
            makeFormSelectorPanel().render('encounterForm');
        }


    }

    function makeFormSelectorPanel(){
        return new Ext.FormPanel({
            border: false
            ,width: 300
            ,labelWidth: 140
            ,items: [{
                xtype: 'combo'
                ,fieldLabel: 'Choose Form Type'
                ,ref: 'category'
                ,allowBlank: false
                ,width: 140
                ,name: 'type'
                ,dataIndex: 'type'
                ,displayField:'category'
                ,valueField: 'category'
                ,forceSelection: true
                ,typeAhead: false
                ,triggerAction: 'all'
                ,mode: 'local'
                ,store: EHR.ext.getLookupStore({
                    containerPath: 'WNPRC/EHR/',
                    schemaName: 'lookups',
                    queryName: 'encounter_types',
                    sort: 'category'
                  })
            }]
            ,buttons: [{
                text: 'Submit'
                ,scope: this
                ,ref: 'submit'
                ,handler: function(s){
                    var val = s.refOwner.ownerCt.category.getValue();
                    if(val)
                        s.refOwner.ownerCt.destroy();
                        renderForm(val);
                }
            }]
        });
    }

    function makeEncounterPanel(encounterType){
        var panel;

        switch (encounterType){
            case 'Physical Exam':
                panel = new EHR.ext.ParentFormPanel({
                    containerPath: 'WNPRC/EHR/',
                    formType: encounterType,
                    uuid: LABKEY.ActionURL.getParameter('uuid'),
            //        header: 'ehr-header'
            //        formXtype: 'tabpanel',
                    formSections: [
                        {
                            xtype: 'ehr-abstractpanel'
                        },{
                            xtype: 'ehr-formpanel',
                            queryName: 'Clinical Remarks',
                            schemaName: 'study',
                            title: 'Clinical Remarks',
                            metadata: EHR.ext.standardEncounterMetadata

                        },{
                            xtype: 'ehr-formpanel',
                            queryName: 'Vitals',
                            schemaName: 'study',
                            title: 'Vitals',
                            metadata: EHR.ext.standardEncounterMetadata
                        },{
                            xtype: 'ehr-formpanel',
                            queryName: 'Dental Status',
                            schemaName: 'study',
                            title: 'Dental Status',
                            metadata: EHR.UTILITIES.rApply(Ext.apply({}, EHR.ext.standardEncounterMetadata), {
                                gingivitis: {requireSelection: true, lookupNullCaption: 'N/A'},
                                tartar: {allowBlank: false, lookupNullCaption: 'N/A'}
                            })
                        },{
                            xtype: 'ehr-formpanel',
                            queryName: 'Body Condition',
                            schemaName: 'study',
                            title: 'Body Condition',
                            metadata: EHR.ext.standardEncounterMetadata
                        },{
                            xtype: 'ehr-formpanel',
                            queryName: 'Alopecia',
                            schemaName: 'study',
                            title: 'Alopecia',
                            metadata: EHR.UTILITIES.rApply(Ext.apply({}, EHR.ext.standardEncounterMetadata), {
                                head: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                dorsum: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                rump: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                shoulders: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                upperArms: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                lowerArms: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                hips: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                upperLegs: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                lowerLegs: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                other: {ext: {xtype: 'ehr-booleanradiogroup', value: null}},
                                score: {lookupNullCaption: ''}
                            })
                        },{
                            title: 'PE Findings',
                            html: 'PE findings'
                        },{
                            title: 'Order ClinPath',
                            html: 'order clinpath tests'
                        },{
                            id: 'treatment_orders',
                            title: 'Order Treatments',
                            xtype: 'ehr-gridformpanel',
                            collapsed: true,
                            schemaName: 'study',
                            queryName: 'Treatment Orders',
                            metadata: EHR.UTILITIES.rApply(Ext.apply({}, EHR.ext.standardEncounterMetadata), {
                                date: {
                                    parentConfig: null,
                                    allowBlank: false,
                                    setInitialValue: function(v, rec){
                                        return v ? v : new Date()
                                    }
                                }
                            })
                        }
                    ]
                });
                break;
            case 'MPR':

                break;
        }

        return panel;
    }
});


</script>
</head>
<body>
<div id="encounterForm"></div>



</body>


</html>