<html>
<head>

<script type="text/javascript">

LABKEY.requiresScript("/ehr/transposeRows.js");

Ext.onReady(function ()
{
    if (!LABKEY.ActionURL.getParameter('runId')){alert('Must Provide Run #'); return false;}
    if (!LABKEY.ActionURL.getParameter('dataset')){alert('Must Provide Dataset Name'); return false;}

    LABKEY.Query.selectRows({
        schemaName: 'study',
        queryName: 'DataSets',
        containerPath: 'WNPRC/EHR/',
        filterArray: [LABKEY.Filter.create('EntityId', LABKEY.ActionURL.getParameter('dataset'), LABKEY.Filter.Types.EQUAL)],
        successCallback: onSuccess
    });

    function onSuccess(data){
        if(!data.rows.length){
            alert('Unable to find dataset');
            return;
        }
            
        var row = data.rows[0];
        var dataset = row.Label.split(' ');
        dataset.pop();
        dataset = dataset.join(' ');

        new EHR.ext.DetailsView({
            schemaName: 'study',
            queryName: dataset+' Runs',
            title: dataset+' Run Details:',
            renderTo: 'runDetails',
            filterArray: [LABKEY.Filter.create('objectid', LABKEY.ActionURL.getParameter('runId'), LABKEY.Filter.Types.EQUAL)]
        });

        new LABKEY.QueryWebPart({
            title: dataset+' Results:',
            schemaName: 'study',
            queryName: dataset+' Results',
            allowChooseQuery: false,
            allowChooseView: true,
            showInsertNewButton: false,
            showDeleteButton: false,
            showDetailsColumn: true,
            showUpdateColumn: false,
            showRecordSelectors: true,
            buttonBarPosition: 'top',
            filterArray: [LABKEY.Filter.create('runId', LABKEY.ActionURL.getParameter('runId'), LABKEY.Filter.Types.EQUAL)],
            scope: this,
            errorCallback: EHR.utils.onError
         }).render('resultDetails');
    }

});

</script>
</head>
<body>
    <p/>

	<div id='runDetails'>Loading...</div>

    <p/>

    <div id='resultDetails'>Loading...</div>

</html>