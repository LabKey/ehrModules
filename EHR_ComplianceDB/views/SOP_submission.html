<html>
<head>
<script type="text/javascript">

Ext.onReady(function()
{

    //we look up this employee's information
    LABKEY.Query.selectRows({
        schemaName: 'lists',
        queryName: 'Employees',
        containerPath: 'WNPRC/WNPRC_Units/Animal_Services/Compliance_Training/Private/EmployeeDB/',
        filterArray: [LABKEY.Filter.create('Email', LABKEY.Security.currentUser.email, LABKEY.Filter.Types.EQUAL)],
        successCallback: onSuccess
    });

    function onSuccess(results)
    {
        if (results.rows.length < 1){alert('No Employee Record Found for User: '+LABKEY.Security.currentUser.email+'.\nPlease contact Sandra Boehm.');return;}

        var email = LABKEY.Security.currentUser.email;

        //then we display a list of all their required SOPs
        var sopQWP = new LABKEY.QueryWebPart({
            renderTo: 'sopDiv',
            dataRegionName: 'sopGrid',
            title: 'Unread SOPs (Less Than 10 Months Until Renewal)',
            schemaName: 'lists',
            queryName: 'SOPrequirements',
            buttonBarPosition: 'top',
            showRecordSelectors: true,
            allowChooseQuery: false,
            //allowChooseView: false,
            successCallback: function(){setButtons('sopGrid', [{text: 'Mark Read', onclick: "markRead('sopGrid')"}])},
            filters: [LABKEY.Filter.create('email', email, LABKEY.Filter.Types.EQUAL), LABKEY.Filter.create('MonthsUntilRenewal', 10, LABKEY.Filter.Types.LESS_THAN)]
        });

        //then we display a list of all completed required SOPs
        var sopQWP2 = new LABKEY.QueryWebPart({
            renderTo: 'sopDiv2',
            //dataRegionName: 'sopGrid',
            title: 'Completed SOPs (More Than 10 Months Until Renewal)',
            schemaName: 'lists',
            queryName: 'SOPrequirements',
            buttonBarPosition: 'top',
            showRecordSelectors: true,
            allowChooseQuery: false,
            //allowChooseView: false,
            //successCallback: function(){setButtons('sopGrid', [{text: 'Mark Read', onclick: "markRead('sopGrid')"}])},
            filters: [LABKEY.Filter.create('email', email, LABKEY.Filter.Types.EQUAL), LABKEY.Filter.create('MonthsUntilRenewal', 10, LABKEY.Filter.Types.GREATER_THAN_OR_EQUAL)]
        });


        //we find remaining SOPs
        LABKEY.Query.selectRows({
            schemaName: 'lists',
            queryName: 'SOPrequirements',
            containerPath: 'WNPRC/WNPRC_Units/Animal_Services/Compliance_Training/Private/SOPs/',
            filterArray: [LABKEY.Filter.create('email', email, LABKEY.Filter.Types.EQUAL), LABKEY.Filter.create('MonthsUntilRenewal', 10, LABKEY.Filter.Types.LESS_THAN)],
            successCallback: makeForm
        });

        function makeForm(data){
            //here is simple JS to make the form
            var theForm = document.getElementById('SOPform');
            var submit = document.getElementById("SOPsubmitButton");

            if (data.rows.length == 0){
                submit.disabled = false;
            }
            submit.onclick = submitRequest
        }


        function setButtons(dataRegionName, buttons)
        {
            var dataRegion = LABKEY.DataRegions[dataRegionName];
            setButtonsForBar(buttons, dataRegion.header);

            //setButtonsForBar(buttons, dataRegion.footer);

            function setButtonsForBar(buttons, area)
            {
                var buttonBar = Ext.DomQuery.selectNode("div.labkey-button-bar", area.dom);
                if (!buttonBar)
                    return;

                var aTags = Ext.DomQuery.select("a", buttonBar);
                if (!area.labkeyButtons)
                {
                    var oldButtons = {};
                    for (var i = 0; i < aTags.length; i++)
                    {
                        var aTag = aTags[i];
                        var buttonNode = aTag.parentNode;
                        //First child is a SPAN tag, it's first child is the text node with the button name...
                        var buttonText = aTag.firstChild.firstChild.nodeValue;
                        oldButtons[buttonText] = buttonNode;
                    }
                    area.labkeyButtons = oldButtons;
                }
                //Delete the old buttons, we are replacing all of them...
//                for (i = 0; i < aTags.length; i++)
//                {
//                    buttonNode = aTags[i].parentNode;
//                    buttonNode.parentNode.removeChild(buttonNode); //Remove them all & put them back later...
//                }

                for (i = 0; i < buttons.length; i++)
                {
                    var buttonConfig = buttons[i];
                    buttonNode = null;
                    if (buttonConfig.labkeyButton)
                        buttonNode = area.labkeyButtons[buttonConfig.labkeyButton];
                    else
                        buttonNode = createButton(buttonConfig);

                    buttonBar.appendChild(buttonNode);
                }
            }

            function createButton(config)
            {
                var href = config.href;
                var onclick = config.onclick || "";
                var cls = 'labkey-button';

                if (!href)
                {
                    href = "#";
                    if (config.action)
                    {
                        var method = config.method || "GET";
                        onclick = "var frm = LABKEY.DataRegions['" + dataRegion.name + "'];frm.action = '" + config.action + "'; " +
                                  "frm.method = '" + method + "'; " +
                                  "frm.submit();";
                    }
                    else if (config.menuItems)
                    {
                        var menuCopy = {id:Ext.id(), cls:"extContainer", items:config.menuItems};
                        new Ext.menu.Menu(menuCopy);
                        onclick = "showMenu(this, '" + menuCopy.id + "', 'tl-bl?')";
                        cls = 'labkey-menu-button';
                    }
                }

                var span = document.createElement("span");
                var menuHTML = config.menuItems ? "&nbsp;<img src='" + LABKEY.contextPath + "/_images/button_arrow.gif' class='labkey-button-arrow'>" : "";
                span.innerHTML = "<a class='" + cls + "' href='" + href + "' onclick=\"" + onclick + "\" ><span>" + LABKEY.Utils.encodeHtml(config.text) + "</span>" + menuHTML + "</a>";
                return span;
            }
        }
    }
});

    function submitRequest() {
        if (!document.getElementById('sopCheck').checked){
            alert('You must check the box above the submit button to certify you have read your SOPs');
            return false;
        }

        LABKEY.Query.insertRows({
             containerPath: '/WNPRC/WNPRC_Units/Animal_Services/Compliance_Training/Private/EmployeeDB',
             schemaName: 'lists',
             queryName: 'CompletionDates',
             scope: this,
             rowDataArray: [{
                RequirementName: 'SOP Review'
                ,EmployeeId: LABKEY.Security.currentUser.displayName
                ,Date: new Date().format("Y-m-d")
                }],
             successCallback: function(){
                alert('Thank You for Reading Your SOPs.  You have now completed your SOP requirements for the year.');
                var url = LABKEY.ActionURL.buildURL(
                    'Project',
                    'begin.view',
                    'home'
                    );

                window.location = url
             },
             errorCallback: function(errorInfo) {
                Ext.Msg.alert("Error:", errorInfo);
                }
            });
     }


    function markRead(dataRegionName) {
        Ext.Msg.wait("Loading...");
        var userName = LABKEY.Security.currentUser.email;

        var dataRegion = LABKEY.DataRegions[dataRegionName];
        var checked = dataRegion.getChecked();

        var request = new LABKEY.MultiRequest({listeners: {'done': onComplete, scope: this}});

        for (var i=0;i<checked.length;i++){
            // Insert form data into the list.
            var value = checked[i].split(',');
            var insertCfg = {
                 containerPath: 'WNPRC/WNPRC_Units/Animal_Services/Compliance_Training/Private/SOPs/',
                 schemaName: 'lists',
                 queryName: 'SOPDates',
                 rowDataArray: [{
                    SOP_ID: value[0]
                    ,EmployeeId: LABKEY.Security.currentUser.displayName
                    ,Date: new Date().format("Y-m-d")
                    }],
                 failureCallback: function(errorInfo) {
                    Ext.Msg.hide();
                    Ext.Msg.alert("Error:", errorInfo);
                    }
                };

            request.add(LABKEY.Query.insertRows, insertCfg);
        }

        request.send({});

        function onComplete(){
             //dataRegion.render();
             dataRegion.selectNone();
             Ext.Msg.hide();
             alert('SOPs Marked Read');
             window.location.reload();
         }
     }


</script>
</head>
<body>
<p>
<li>
    Below is a list of the SOPs you are required to read, based on your position at WNPRC.  If you believe there is an error, please contact Sandra Boehm <a href="<%=contextPath%>/issues/WNPRC/WNPRC_Units/Animal_Services/Compliance_Training/Issue_Tracker/list.view?" target="new">here</a>
</li>
<br>
<li>
    Each SOP must be read every 12 months.  The 'Months Until Renewal' column indicates how soon you must re-read each SOP.     
</li>
<br>
<li>
    To download an SOP, click the PDF icon in the PDF column.
</li>
<br>
<li>
    Once you have read an SOP, check the box next to it and hit the 'Mark Read' button above the grid.  Today's date should now appear next to this SOP, indicating that you have read it.  Note that once you mark an SOP read, it will jump to the bottom 'Completed' grid.
</li>
<br>
<li>
    IMPORTANT: Once you read all of your SOPs and have marked them as read, you need to check the box next to 'I Certify That I have read all the required SOPs', then hit submit.  The submit button will be greyed out until all of your SOPs have been marked read.
</li>
<p/>

<hr>

<br>
<table border="1" id="SOPform">
    <tr>
        <td>
            I certify that I have read all the required SOPs.
            <input type="checkbox" id="sopCheck" value="1"/>
            <br><br>
            <button id="SOPsubmitButton" disabled="true">Submit</button>
            <br>
            <!--<i></i>**This buttom will be greyed out until all your SOPs have been marked read.</i>-->
        </td>
    </tr>
</table>

<br><br>

<div id="sopDiv">Loading...</div>

<br><br>

<div id="sopDiv2">Loading...</div>

</body>
</html>